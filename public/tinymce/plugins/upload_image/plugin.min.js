/**
 * QR code - a TinyMCE 4 QR code wizzard
 * qrcode/plugin.js
 *
 *
 * Plugin info: http://www.cfconsultancy.nl/
 * Author: Ceasar Feijen
 *
 * Version: 1.0 released 15/09/2013
 */
tinymce.PluginManager.add('upload_image',function(editor){
	var swfu;
	editor.on('init', function() {
		// var config = this.getSWFConfig(btn);
        // var swfupload = new SWFUpload(config);
        // console.log(editor);
    });
    editor.on('remove', function(e) {
    });
	function handle(){
		// editor.insertContent('<img src="'+tinyMCE.baseURL+'/plugins/upload_image/icon.png"'+'/>');
	}
	editor.addButton('upload_image',{
		icon:true,
		// image:tinyMCE.baseURL+'/plugins/upload_image/icon.png',
		tooltip:'图片上传',
		shortcut:'Ctrl+UI',
		onPostRender:function(obj){
			$("#"+obj.control._id).append('<i class="mce-ico mce-i-image" id="upload_images" style="position:absolute;left:0;cursor: pointer;width:26px;height:22px;z-index:9"></i>');
            var settings = {
                flash_url : "public/swfupload/swfupload.swf",
                flash9_url : "public/swfupload/swfupload_fp9.swf",
                upload_url: "admin/common/upload",
                file_size_limit : "10 MB",
                file_types : "*.jpg;*.png;*.gif;",
                file_types_description : "All Files",
                file_upload_limit : 100,
                file_queue_limit : 0,
                custom_settings : {
                },
                debug: false,
                post_params : {
					"details":"images"
					// "prefix":
                },
                button_placeholder_id: 'upload_images',
                button_window_mode: SWFUpload.WINDOW_MODE.TRANSPARENT,
				button_cursor: SWFUpload.CURSOR.HAND,
                button_width: 26,
                button_height: 22,
                swfupload_preload_handler : swfupload_preload_handler,
                swfupload_load_failed_handler : swfupload_load_failed_handler,
                swfupload_loaded_handler : swfupload_loaded_handler,
                file_dialog_start_handler : file_dialog_start_handler,
                file_queued_handler : file_queued_handler,
                file_queue_error_handler : file_queue_error_handler,
                file_dialog_complete_handler : file_dialog_complete_handler,
                upload_start_handler : upload_start_handler,
                upload_progress_handler : upload_progress_handler,
                upload_error_handler : upload_error_handler,
                upload_success_handler : upload_success_handler,
                upload_complete_handler : upload_complete_handler
            };
            swfu = new SWFUpload(settings);
            $("#"+obj.control._id).find('i').addClass('mce-i-image');
            $("#"+swfu.movieName).css({
                width:26,
                height:22,
                top:0,
                left:0,
                position:'absolute',
                cursor: 'pointer'
            });
			function swfupload_preload_handler(){
				console.log('1.swfupload_preload_handler');
				if (!this.support.loading) {
					return false;
				}
			}
			function swfupload_load_failed_handler(){
				Ext.Msg.show({
					title : '提示',
					msg : 'SWFUpload加载失败！',
					width : 180,
					icon : Ext.Msg.ERROR,
					buttons :Ext.Msg.OK
				});
			}
			function swfupload_loaded_handler(){
				console.log('2.swfupload_loaded_handler');
			}
			function file_dialog_start_handler(){
				console.log('3.file_dialog_start_handler');
			}
			function file_queued_handler(file){ //文件列队
				console.log('4.file_queued_handler');
			}
			function file_dialog_complete_handler(){
				console.log('5.file_dialog_complete_handler');
				if (this.getStats().files_queued > 0) {
					this.startUpload();
				}
			}
			function file_queue_error_handler(file, errorCode, message){ //文件列队错误
				console.log('6.file_queue_error_handler');
				switch(errorCode){
					case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED : msg('上传文件列表数量超限,不能选择！');
				break;
					case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT : msg('所选文件大小超过限制, 不能选择！');
				break;
					case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE : msg('文件大小为0,不能选择！');
				break;
					case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE : msg('文件类型不允许上传！');
				break;
				}
				function msg(info){
					Ext.Msg.show({
						title : '提示',
						msg : info,
						width : 250,
						icon : Ext.Msg.WARNING,
						buttons :Ext.Msg.OK
					});
				}
			}
			function upload_start_handler(file){ //开始上传
				console.log('6.upload_start_handler');
			}
			function upload_progress_handler(file, bytesLoaded, bytesTotal){ //上传文件进度
				console.log('7.upload_progress_handler');
			}
			function upload_error_handler(file, errorCode, message){ //上传文件失败
				console.log('upload_error_handler');
			}
			function upload_success_handler(file, serverData, responseReceived){ //上传文件成功
				console.log('8.upload_success_handler');
				if (this.getStats().files_queued > 0) {
					this.startUpload();
				}
				if(serverData){
					var datas = Ext.JSON.decode(serverData);
					editor.insertContent('<img src="upload/images/'+datas.data.dir+'/'+datas.data.savename+'" />');
				}
			}
			function upload_complete_handler(file){ //上传文件结束
				console.log('9.upload_complete_handler');
			}
		}
		// onclick:handle
	});
});
